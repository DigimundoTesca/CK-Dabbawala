{% extends "base/base_nav_footer.html" %} 
{% load static %} 
{% block link %}
<link rel="stylesheet" type="text/css" href="{% static 'css/kitchen/shoplist.css' %}"> 
{% endblock link %} {% block content %}

<!--Container of List-->
<div class="container-fluid"> 
    <div class="row">        
        <div class="col-6 col-md-4">
            <div class="tab_list list-group" id="list-tab" role="tablist">
                {% for sp in supplies %} 
                    {% if sp == supplies|first %}
                    <a class="list-group-item list-group-item-action active" id="list-{{sp.pk}}-list" data-toggle="list" href="#{{sp.pk}}-home" role="tab" aria-controls="{{sp.pk}}">
                    {% else %}
                    <a class="list-group-item list-group-item-action" id="list-{{sp.pk}}-list" data-toggle="list" href="#{{sp.pk}}-home" role="tab" aria-controls="{{sp.pk}}">
                    {% endif %} 
                    {{sp.name}}
                    </a>
                {% endfor %}
            </div>
        </div>
        <div class="col-6 col-md-4">
            <div class="tab-content" id="nav-tabContent">
                {% for sp in supplies %} 
                    {% if sp == supplies|first %}
                    <div class="tab-pane fade show active" id="{{sp.pk}}-home" role="tabpanel" aria-labelledby="list-{{sp.pk}}-list">
                    {% else %}
                    <div class="tab-pane fade" id="{{sp.pk}}-home" role="tabpanel" aria-labelledby="list-{{sp.pk}}-list">
                    {% endif %}
                        <div class="row">
                            <div class="sect_img">
                                <p class="text-center">{{sp.name}}</p>
                                <img src="{{sp.image.url}}" alt="No img">
                            </div>
                        </div>                       
                        <div class="row">
                            <div class="col-12 sect_btn">
                            {% for presentation in presentations %} 
                                {% if presentation.supply == sp %}                                
                                    <button class="btn-pres btn btn-danger col-12" id="{{presentation.getElements}}">
                                        {{presentation.getDescription}}
                                    </button>
                                    <br><br>   
                                {% endif %} 
                            {% endfor %}
                            </div>
                        </div>                        
                        <button type="button" class="btn-new-pres btn btn-primary col-12">
                            Agregar Presentacion
                        </button>                        
                    </div>                                               
                 {% endfor %}
            </div>
        </div>                
        <div class="col-md-4">
            <div class="tab_view col-md-12">
                <table class="table table-striped table-dark" id="TableID">
                    <thead>
                        <tr align="center">
                            <th>Cantidad</th>
                            <th>Nombre</th>                            
                            <th>Presentacion</th>
                            <th>Costo</th>
                        </tr>
                    </thead>
                    <tbody>
                
                    </tbody>
                </table>
            </div>
            <button type="button" id="clear-btn" class="btn btn-primary col-12">
                Borrar Todo
            </button>
        </div>
    </div>
</div>

<!--FloatingButton-->
<div class="popout">
    <div class="FAB" id="fab-save-shoplist">
        <i class="material-icons">save</i>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel"> Agregar Presentacion</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                {{form.as_p}}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary">Agregar</button>
            </div>
        </div>
    </div>
</div>


{% endblock content %} 
{% block javascript %}
<script type="text/javascript" charset="utf-8">

    var js_list = "{{presentations}}";

    let table_array = [];

    function get_cookie(name) {
            let cookie_value = null;
            if (document.cookie && document.cookie !== '') {
                let cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = jQuery.trim(cookies[i]);
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookie_value = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookie_value;/**/
        }

    $('.btn-pres').click(function () {
        var a = $(this).attr('id');
        var arr = a.split("&");        
        arr.push(1);
        var res = check_repeat(arr);        
        if (res ==-1){
            table_array.push(arr);    
        }else{
            table_array[res][6]+=1;
            var a = parseInt(table_array[res][3])
            var b = parseInt(arr[3])
            table_array[res][3]=a+b;
        }                
        pop_table();
    });

    function check_repeat(arr){        
        for (var i=0;i<table_array.length;i++){            
            if(table_array[i][5].localeCompare(arr[5]) == 0 ){                
                return i;
            }
        }
        return -1;
    }

    function pop_table(){
        console.log(table_array);
        var html_list = ""; 
        $("#TableID tbody").empty();
        for (var x=0;x<table_array.length;x++){
            html_list +=
                '<tr align="center">' +
                '<th>' + table_array[x][6] + '</th>' +
                '<th>' + table_array[x][0] + '</th>' +
                '<th>' + table_array[x][4] + "  " + table_array[x][1] + "  " + table_array[x][2] + '</th>' +
                '<th>' + table_array[x][3] + '</th>' +
                '</tr>';
        }
        $("#TableID tbody").append($(html_list));
    }

    $('#clear-btn').on('click', function(e){
        table_array = [];
        pop_table();
    });

    $(".btn-new-pres").on('click', function(e){
        $('#myModal').modal();
    });

    $(".FAB").on("click", function (e) {
            let csrf_token = get_cookie('csrftoken');
            let JSONSale = JSON.stringify(table_array);
            if (table_array.length > 0) {
                $.ajax({
                    url: '{% url "products:new_shoplist" %}',
                    type: 'POST',
                    data: {
                        'type': 'shop_list',
                        'shop_list': JSONSale,
                        csrfmiddlewaretoken: csrf_token,
                    },
                    traditional: true,
                    datatype: 'jsonp',
                    success: function (result) {
                        swal({
                            title: "Ã‰xito",
                            text: "Lista Guardada",
                            type: "success",
                            showConfirmButton: false,
                        });
                        location.replace('{% url "products:shoplist" %}');
                    },
                    error: function (result, jqXHR, textStatus, errorThrown) {
                        swal({
                            title: "Lista no Guardada!",
                            text: 'Contacte a soporte!\n ' + 'Errores: ' + textStatus + ', ' + jqXHR,
                            type: "error",
                            showConfirmButton: false
                        });
                        setTimeout(rel, 30000);
                    },
                });
            } else {
                swal({
                    title: "La lista esta vacia!",
                    text: 'Agregue elementos a la lista!',
                    type: "warning",
                    showConfirmButton: false
                });
                setTimeout(rel, 30000);
            }
        });


</script>
{% endblock javascript %}