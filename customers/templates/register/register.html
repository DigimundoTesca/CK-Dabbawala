{% extends "dabbawala/base_nav_footer.html" %}
{% load static %}

{% block stylesheets %}
<style media="screen">
  #map {
    height: 400px;
    width: 100%;
    margin-top: 30px;
  }
</style>
{% endblock stylesheets%}

{% block content %}
<div id="main"> 
  <img class="bord2" src="{% static 'images/image/reverse.png' %}" alt="Borde">
  <h2>bienvenido a </h2>
  <h1>Dabbawalla</h1>
  <div class="regis">
    <p>Registrate y obtén<br><span>UN DESAYUNO GRATIS</span><br><br></p>
  </div>
</div>
<div id="main">
  <img class="arr" src="{% static 'images/image/arrow.png' %}" alt="Borde">
  <div class="form">
    <form action="" method="POST" class="form-register-customer">
      <div class="cols colr">
        <div class="col1 formr">
          {% csrf_token %}
          <label for="name">Nombre con el que te identificaremos. Obligatorio</label>
          <input type="text" class="form-control" id="id_name" name="{{ form_customer.user.name }}" placeholder="Nombre de usuario" maxlength="30" value="{% if form_customer.user.value == None %}{% else %}{{ form_customer.user.value }}{% endif %}" required autofocus onkeypress="return pulsar(event)" >
          {%  if form_customer.user.errors %}
          <div class="has-danger">
            {%  for error in form_customer.user.errors %}
            <small class="form-control-feedback">
              {{ error|escape }}
            </small>
            {% endfor %}
          </div>
          {% endif %}
          <label for="email">Correo. Obligatorio</label>
          <input type="email" class="form-control" id="id_email" name="{{ form_customer.email.name }}" placeholder="Correo" maxlength="255" value="{% if  form_customer.email.value == None %}{% else %}{{ form_customer.email.value }}{% endif %}" required onkeypress="return pulsar(event)" >
          {%  if form_customer.email.errors %}
          <div class="has-danger">
            {%  for error in form_customer.email.errors %}
            <small class="form-control-feedback">{{ error|escape }}
            </small>
            {% endfor %}
          </div>
          {% endif %}
          <label for="telefono">Obligatorio</label>
          <input type="text" class="form-control" id="id_phone_number" name="{{ form_customer.phone_number.name }}" placeholder="Número con WhatsApp" maxlength="10" value="{% if  form_customer.phone_number.value == None %}{% else %}{{ form_customer.phone_number.value }}{% endif %}" required onkeypress="return pulsar(event)" >
          {%  if form_customer.phone_number.errors %}
          <div class="has-danger">
            {%  for error in form_customer.phone_number.errors %}
            <small class="form-control-feedback">{{ error|escape }}
            </small>
            {% endfor %}
          </div>
          {% endif %}
          <input type="hidden" class="form-control " id="id_longitude" name="longitude" value="{{ form_customer.longitude.value }}">
          <input type="hidden" class="form-control" id="id_latitude" name="latitude" value="{{ form_customer.latitude.value }}">
          <div class="col-xs-12">
            <small id="id_address_help" class="form-text text-muted"></small>
          </div>
          <label for="addres">Dirección</label>
          <div id="innerbtn">
            <input type="text" class="form-control" id="id_address" name="address" placeholder="Busca tu dirección" maxlength="255" onkeypress="return search(event)" required="">
            <a class="icon alt fa-search" type="" id="btn-search"></a>
            {%  if form_customer.address.errors %}
            <div class="has-danger">
              {%  for error in form_customer.address.errors %}
              <small class="form-control-feedback">{{ error|escape }}
              </small>
              {% endfor %}
            </div>
            {% endif %}
          </div>
          <div id="container-msj-alert" class="form-group container-hidden">
            <div class="alert alert-warning" role="alert">
              <strong>Oops! </strong><span id="msj-alert">mensaje</span>
            </div>
          </div>
          <button id="getJson" type="submit" class="btn btn-success btn-block">Registrate</button>
        </div>
        <div class="col2 mapr map-container">
          <div id="map" class=""></div> 
        </div>
      </div>
    </form>
  </div>
</div>
<div id="main">
  <img class="arr" src="{% static 'images/image/arrow.png' %}" alt="Borde" height="60px">
  <div class="form">
    <h2>¿TIENES ALGUNA DUDA O SUGERENCIA?</h2>
    <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. </p>
    <form class="col sections" action="" method="post" accept-charset="utf-8">
      <div class="col1">
        <input type="text" name="email" id="email" placeholder="Email" />
        <input type="submit" class="fit" name="submit" value="Enviar" />
      </div>
      <div class="col2">
        <textarea name="message" placeholder="Mensaje" id="message" rows="2"></textarea>
      </div>
    </form>
  </div>
</div>
{% endblock content %}

{% block scripts %}
<script type="text/javascript">
  var map;
  var infoWindow;
  var marker;

  function drawMap (options) {
    map = new google.maps.Map($("#map").get(0), options);
  }

  function setAddressValue (address) {
    $('#id_address').val(address);
  }

  function setLatLng(lat, lng){
    $('#id_latitude').val(lat);
    $('#id_longitude').val(lng); 
  }

  function openInfoWindow(marker) {
    var markerLatLng = marker.getPosition();
    infoWindow.setContent([
      'Aquí enviaremos tu Dabba.'
      ].join(''));

    infoWindow.open(map, marker);

    var Latitude = $('#id_latitude').val();
    var Longitude = $('#id_longitude').val();

    setLatLng(latitude, longitude);
  }

  function addMarkerLsteners (marker) {
    google.maps.event.addListener(marker, 'dragend', function(){ 
      openInfoWindow(marker); 
    });
    google.maps.event.addListener(marker, 'click', function(){ 
      openInfoWindow(marker); 
    });
  }

  function initMap() {
    var LatLng = new google.maps.LatLng(19.5228008,-99.2291418);
    var optionsMap = {
      zoom: 15,
      center: LatLng,
      mapTypeId: google.maps.MapTypeId.ROADMAP,
    }

    infoWindow = new google.maps.InfoWindow();

    drawMap(optionsMap);

    marker = new google.maps.Marker({
      animation: google.maps.Animation.DROP,
      draggable: true,
      map: map,
      position: LatLng,
    });

    addMarkerLsteners(marker);
    openInfoWindow(marker);

  }

  $('#btn-search').on('click', function() {
    var address = $('#id_address').val();
    var geocoder = new google.maps.Geocoder();
    geocoder.geocode({'address': address}, geocodeResult);
  });

  function pulsar(e) {
    tecla = (document.all) ? e.keyCode :e.which;
    return (tecla!=13);
  }

  function search(e) {
    var code = (e.keyCode ? e.keyCode : e.which);
    if(code == 13) { 
      var address = $('#id_address').val();
      var geocoder = new google.maps.Geocoder();
      geocoder.geocode({'address': address}, geocodeResult);
    }

    return (code!=13);
  }

  function geocodeResult(results, status) {
    if (status == 'OK') {
      var address = results[0].formatted_address;
      setAddressValue(address);

      var optionsMap = {
        zoom: 15,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
      }

      drawMap(optionsMap);
      map.fitBounds(results[0].geometry.viewport);

      var markerOptions = { 
        position: results[0].geometry.location,
        draggable: true, 
        animation: google.maps.Animation.DROP,
      }

      marker = new google.maps.Marker(markerOptions);
      marker.setMap(map);

      var latitude = marker.position.lat();
      var longitude = marker.position.lng();

      setLatLng(latitude, longitude);


      addMarkerLsteners(marker);

    } else {
      /** If there's not results */
      $("#msj-alert").text('No encontramos tu dirección');
      $("#container-msj-alert").fadeIn(1500);
      setTimeout(function() {
        $("#container-msj-alert").fadeOut(1500);
      },6000);
    }
  }
  $(function() {
    initMap();
  });
</script>
<script>
  $('#getJson').on('click', function() {
    let name, addres, mail, phone;
    let URL = "{% url 'customers:register' %}";
    name = $('#id_name').val();
    addres = $('#id_address').val();
    mail = $('#id_email').val();
    phone = $('#id_phone_number').val();
    let new_user = new Object();
    new_user.name = name;
    new_user.mail = mail;
    new_user.phone = phone;
    new_user.addres =  addres;

    let userJson = JSON.stringify(new_user);
    console.log(new_user)
    console.log(userJson)

    $.ajax({
      url: "{% url 'customers:register' %}",
      type: 'POST',
      data: {
        csrfmiddlewaretoken: '{{ csrf_token }}',
        'newuser': userJson,
      },
      traditional: true, 
      datatype: 'jsonp',
    })
    .done(function() {
      console.log("success");
    })
    .fail(function() {
      console.log("error");
    })
    .always(function() {
      console.log("complete");
    });
    
  });
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCrITfQswCPmOPEBRM1Ufeiogh22FxQV5k" defer charset="utf-8"></script>
{% endblock scripts %}