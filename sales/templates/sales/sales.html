{% extends 'base/base_nav_footer.html' %}

{% load static %}

{% block page_title %}
  {{ page_title }}
{% endblock %}

{% block content %}
<div class="container-fluid container-sales-reports">
  <div class="row">
    <div class="col-12 offset-md-10 col-md-2">
      <div class="text-xs-right mb-2">
        <form class="form-inline" id="dates-range-form">
          <label for="dt-year" hidden></label>
          <select class="custom-select" id="dt-year">
          </select>
          <select class="custom-select" id="dt-week"  title="dt-week">
          </select>
        </form>
      </div>
    </div>
  </div>
  <div class="row container-sales-header">
    <div class="col-xs-12 col-md-6">
      <div class="text-xs-center">
        <p>Ventas de la semana <span id="week-number">{{ week_number }}</span>:
        <span class="font-weight-bold">$</span>
        <span id="total-earnings-text" class="font-weight-bold"></span></p>
      </div>
    </div>
    <div class="col-xs-12 col-md-6">
      <div class="row">
        <div class="col-xs-6">
          <p class="float-xs-right">Hoy es: <span class="font-weight-bold">{{ today_name }}</span></p>
        </div>
        <div class="col-xs-6">
          <p class="float-xs-right">Semana Actual: <span class="font-weight-bold">{{ week_number }}</span></p>
        </div>
      </div>
    </div>
  </div>
  <div class="row sales-graphics">
    <div class="col-xs-12 col-lg-6">
      <div class="canvas-holder">
        <canvas id="canvas-week-sales"></canvas>
      </div>
    </div>
    <div class="col-xs-12 col-lg-6">
      <div class="canvas-holder">
        <canvas id="canvas-day-sales"></canvas>
      </div>
    </div>
  </div>
  <div class="row sales-details">
    <div class="col-xs-12">
      <h4 class="col-xs-12 col-sm-8 col-xl-10">Ventas de hoy</h4>
      <a id="save-reports" href="{% url 'sales:sales_report' %}" class="col-xs-12 col-sm-4 col-xl-2 btn btn-primary d-flex" download>
        <span class="btn-reports d-flex align-items-center"><i class="material-icons">file_download</i>Generar Reporte</span>
      </a>
    </div>
    <div class="col-xs-12">
      <div class="card card-scroll-x mt-1">
        <table id="sales-details-table" class="table table-hover table-sales-details">
          <thead class="thead-inverse">
            <tr>
              <th>Id</th>
              <th>Orden</th>
              <th class="header-date">Fecha</th>
              <th class="header-products">Productos</th>
              <th class="header-packages">Paquetes</th>
              <th>Vendedor</th>
              <th>Total</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for ticket in tickets %}
            <tr class="table-row">
              <th class="header-id table-row-id">{{ ticket.id }}</th>
              <th>{{ ticket.order_number }}</th>
              <td class="header-date">{{ ticket.created_at }}</td>
              <td class="header-products">
                {% for cartridge in ticket.cartridges %}
                <span class="badge badge-success">
                  <span class="badge badge-info" >{{ cartridge.quantity }}</span>
                  <span class="badge badge-success ">{{ cartridge.name }}</span>
                </span>
                {% endfor %}
              </td>
              <td class="header-packages">
                {% for package in ticket.packages %}
                <span class="badge badge-primary">
                  <span class="badge badge-info">{{ package.quantity}}</span>
                  <span class="badge badge-primary">{{ package.name }}</span>
                </span>
                {% endfor %}
              </td>
              <td>{{ ticket.cashier }}</td>
              <td class="td-total">
                {{ ticket.total }}
              </td>
              <td class="header-actions">
                <span class="sales-actions delete-ticket"><i class="material-icons text-muted">delete</i></span>
                <span class="sales-actions print-ticket"><i class="material-icons text-primary">local_printshop</i></span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Ticket Modal -->
<div class="modal fade" id="modal-ticket" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content modal-ticket">
      <div class="modal-header">
        <h5 class="modal-title">Imprimir Ticket</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="printer-container">
            <iframe id="ticket-modal-frame" class="iframe-ticket" src="" frameborder="0"></iframe>
          </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block javascript %}
<script src="{% static 'js/jquery.PrintArea.js' %}"></script>
<script src="{% static 'js/Chart.bundle.min.js' %}" defer></script>
<script src="{% static 'js/jspdf.customfonts.min.js' %}" defer></script>
<script src="{% static 'js/jspdf.autoprint.min.js' %}" defer></script>
<script src="{% static 'js/default_vfs.js' %}" defer></script>

<script type="text/javascript" charset="utf-8" defer>
  $(function() {
    const PATH = window.location.pathname;

    let ctx_week = document.getElementById("canvas-week-sales"),
        ctx_day = document.getElementById("canvas-day-sales"),
        earnings_week_chart,
        earnings_day_chart,
        today_date,
        csrfToken = getCookie('csrftoken');

    let sales_week = JSON.parse('{{ sales_week | safe }}'),
        dates_range = JSON.parse('{{ dates_range | safe }}');
    /**
     * returns a list with the earnings of the week per day
     */
    function get_earnings_week_list() {
      let earnings_list = [],
          count = 0;

      while (count < sales_week.length) {
        earnings_list.push(parseFloat(sales_week[count].earnings));
        count++;
      }
      return earnings_list;
    }

    /**
     * returns a list with the earnings of the week per day with the days to set
     */
    function get_earnings_week_range(sales_list) {
      let week_list = [0, 0, 0, 0, 0, 0, 0,];

      for (let i = 0; i < 7; i++) {
        for (let j = 0; j < sales_list.length; j++) {
          if (sales_list[j].number_day === i) {
            week_list[i] = sales_list[j]['earnings']
          }
        }
      }
      return week_list;
    }

    /**
     * Receives an hour in 24-hour format and returns the same hour but
     * converted into minutes.
     * The string must have to have the following format: hh:mm
     */
    function hours_to_minutes(original_time) {
      let hours,
          minutes;
        hours = parseInt(original_time.split(':')[0])*60;
        minutes = parseInt(original_time.split(':')[1]);
      return parseInt(hours + minutes);
    }

    /**
     * Receives an hour in minutes format and returns the same hour but
     * converted into 24-hour format.
     * The string returned have the next format: hh:mm
     */
    function minutes_to_hours(original_time) {
      let hours = parseInt(original_time / 60),
          minutes = parseInt(original_time % 60);

      if (hours.toString().length < 2) {
        hours = "0"+hours;
      }

      if (minutes.toString().length < 2) {
        minutes = "0"+minutes;
      }
        return hours + ':' + minutes;
    }

    /**
     * Receives an hour and verifies if it't is in the offered time range.
     * The hours received must have the following format: hh:mm
     * Returns true if the condition is met. Otherwise returns false.
     */
    function is_time_in_range(hour, start_hour, end_hour) {
      let hour_in_minutes = hours_to_minutes(hour),
          start_hour_in_minutes = hours_to_minutes(start_hour),
          end_hour_in_minutes = hours_to_minutes(end_hour);

      return hour_in_minutes >= start_hour_in_minutes && hour_in_minutes < end_hour_in_minutes;

    }

    /**
     * Receives a datetime with format from python.
     * Returns an hour converted into 24-hours format: hh:mm ith Timezone +06:00
     */
    function convert_datetime_to_hour(original_datetime){
      return original_datetime.split('T')[1].split('.')[0].substr(0, 5);
    }

    /**
     * Returns a list with the earnings of each time range
     */
    function get_sales_day_list(initial_hour, final_hour, separation_time, sales_list) {
      let initial_hour_minutes,
          final_hour_minutes;

      let list_formatted = [],
          elements_ok = [],
          earnings = 0;

      initial_hour_minutes = hours_to_minutes(initial_hour);
      final_hour_minutes = hours_to_minutes(final_hour);

      while(initial_hour_minutes < final_hour_minutes) {
        let start_hour_f = minutes_to_hours(initial_hour_minutes),
            end_hour_f = minutes_to_hours(initial_hour_minutes + separation_time);

        for (let i = 0; i < sales_list.length; i++) {
          let hour_sale = convert_datetime_to_hour(sales_list[i].datetime);

          if(is_time_in_range(hour_sale, start_hour_f, end_hour_f)) {
            earnings += parseFloat(sales_list[i].earnings);
            elements_ok.push(sales_list[i]);
          }
        }

        list_formatted.push(earnings);
        initial_hour_minutes += separation_time;
        earnings = 0;
      }

      // Searches the times outside the time range
      for(let i = 0; i < sales_list.length; i++) {
        if(elements_ok.indexOf(sales_list[i]) === -1) {
          earnings += parseFloat(sales_list[i].earnings);
        }
      }
      list_formatted.push(earnings);
      return list_formatted.reverse();
    }

    /*
     * Get's the earnings of the selected day in week chart and
     * show the results in sales day chart
     */
    function set_sales_day_chart(date) {
      let earnings_list = [];

      $.ajax({
        url: "{% url 'sales:sales' %}",
        type: 'POST',
        data: {
          csrfmiddlewaretoken: '{{ csrf_token }}',
          'date': date,
          'type': 'sales_day',
        },
        traditional: true,
        datatype: 'jsonp',
        beforeSend: function(){
          // swal({
          //     title: "Generando gráficas",
          //     text: "Espere mientras se calculan los datos",
          //   });
          // swal.enableLoading();
        },
        success: function(result) {
          let sales_day_earnings_list;
          let initial_hour = '06:00',
              final_hour = '16:00',
              separation_time = 60; // In minutes
          let sales_day_object_list = result['sales_day_list'];

          sales_day_earnings_list = get_sales_day_list(initial_hour, final_hour, separation_time, sales_day_object_list);
          earnings_day_chart.data.datasets[0].data = sales_day_earnings_list;
          earnings_day_chart.update();

          swal({
            title: "Éxito",
            text: "Gráfica generada",
            type: "success",
            timer: 600,
            showConfirmButton: false
          }).then(
          function(){},
          function(dismiss){}
          );
        },

        error: function(result, jqXHR, textStatus, errorThrown) {
          console.log(result);
        },
      });
    }

    function convert_date_to_str(date) {
      let months = {
        1: 'Ene', 2: 'Feb', 3: 'Mar', 4: 'Abr', 5: 'May', 6: 'Jun',
        7: 'Jul', 8: 'Ago', 9: 'Sep', 10: 'Oct', 11: 'Nov', 12: 'Dic',
      };
      date = date.split('-');
      return date[0] + " " + months[parseInt(date[1])] + " " + date[2];
    }

    function fill_dates_range_form() {
      let selected_year;
      $.each(dates_range, function(index, item) {
         $('#dates-range-form').find('#dt-year').append(
            "<option value=" + item.year + ">" + item.year + "</option>"
          );
      });

      selected_year = parseInt($('#dates-range-form').find('#dt-year').val());

      $.each(dates_range, function(index, item) {
        if (dates_range[index].year ===  selected_year) {
          $.each(dates_range[index].weeks_list, function(index, item) {
            $('#dates-range-form').find('#dt-week').append(
              "<option value=" + item.start_date + "," + item.end_date + ">" +
              "Semana " + item.week_number + ": " +
              convert_date_to_str(item.start_date) +
              " - " + convert_date_to_str(item.end_date) +
              "</option>"
            );
          });
          return false;
        }
      });
      today_date = $('#dt-week').val().split(',')[1];
    }

    /**
     * Draws the chart of sales of the week
     */
    earnings_week_chart = new Chart(ctx_week, {
      type: 'bar',
      data: {
        labels: ["Lunes", "Martes", "Miercoles", "Jueves", "Viernes", "Sábado", "Domingo"],
        datasets: [{
          label: 'Ventas del día',
          data: get_earnings_week_list(),
          backgroundColor: [
          'rgba(241,196,15,0.7)',
          'rgba(230,126,34,0.7)',
          'rgba(231,76,60,0.7)',
          'rgba(26,188,156,0.7)',
          'rgba(46,204,113,0.7)',
          'rgba(52,152,219,0.7)',
          'rgba(52,73,94,0.7)',
          ],
          borderColor: [
          'rgba(241,196,15,0.9)',
          'rgba(230,126,34,0.9)',
          'rgba(231,76,60,0.9)',
          'rgba(26,188,156,0.9)',
          'rgba(46,204,113,0.9)',
          'rgba(52,152,219,0.9)',
          'rgba(52,73,94,0.9)',
          ],
        }]
      },
      options: {
        responsive: true,
        onClick: function(event, legendItem) {
          try {
            let selected_day = legendItem[0]._index;
            for (let i = 0; i < sales_week.length; i++) {
              if (sales_week[i].number_day === selected_day) {
                set_sales_day_chart(sales_week[i].date);
              }
            }
          } catch (error) {
            console.log(error.message);
          }
        },
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true,
            },
          }]
        }
      }
    });

    /**
     * Draws the chart of sales of the day
     */
    earnings_day_chart = new Chart(ctx_day, {
      type: 'horizontalBar',
      data: {
        labels: [
        "Out", "15:00 - 16:00", "14:00 - 15:00", "13:00 - 14:00",
        "12:00 - 13:00", "11:00 - 12:00", "10:00 - 11:00", "09:00 - 10:00",
        "08:00 - 09:00", "07:00 - 08:00", "06:00 - 07:00"
        ],
        datasets: [{
          label: 'Ventas en este horario',
          data: [],
          backgroundColor: [
          'rgba(247,202,24,0.7)',
          'rgba(247,202,24,0.7)',
          'rgba(247,202,24,0.7)',
          'rgba(247,202,24,0.7)',
          'rgba(247,202,24,0.7)',
          'rgba(46,204,113,0.7)',
          'rgba(46,204,113,0.7)',
          'rgba(46,204,113,0.7)',
          'rgba(46,204,113,0.7)',
          'rgba(46,204,113,0.7)',
          'rgba(46,204,113,0.7)',
          ],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        onClick: function(event, legendItem) {
          try {
            console.log(legendItem[0]._index);
          }
          catch(error) {
            console.log(error.message);
          }
        },
        scales: {
          xAxes: [{
            ticks: {
              beginAtZero: true
            }
          }]
        }
      }
    });

    /**
     * Receives a number and returns it with currency format
     */
    function set_number_format(amount, decimals) {
      let amount_parts,
          regexp = /(\d+)(\d{3})/;

      amount += '';
      amount = parseFloat(amount.replace(/[^0-9.]/g, ''));
      decimals = decimals || 0;

      if (isNaN(amount) || amount === 0)
        return parseFloat(0).toFixed(decimals);

      amount = '' + amount.toFixed(decimals);
      amount_parts = amount.split('.');

      while (regexp.test(amount_parts[0]))
        amount_parts[0] = amount_parts[0].replace(regexp, '$1' + ' ' + '$2');

      return amount_parts.join('.');
    }

    /**
     * Calculates total earnings in the actual week and print it
     */
    function set_total_earnings() {
      let total_earnings = 0;
      let earnings_list = get_earnings_week_list();
      for (let i = 0; i < earnings_list.length; i++) {
        total_earnings += earnings_list[i];
      }
      total_earnings = set_number_format(total_earnings, 2);
      $('#total-earnings-text').append(total_earnings);
    }

    /**
     * Obtiene la información del ticket específico y la muestra para impresión
     *    TODO: Make an iframe to print the ticket
     */
    $('.print-ticket').click(function(event) {
      let target = $(this)[0];
      let idElement = findParentBySelector(target, '.table-row').querySelector('.table-row-id').textContent;

      let data = new FormData();

      // Petición para obtener detalles del ticket seleccionado
      data.append('csrfmiddlewaretoken', csrfToken);
      data.append('ticket_id', idElement);
      data.append('type', 'ticket_details');

      swal({
        title: "Obteniendo datos del ticket",
        text: "Espere mientras obtenemos toda la información",
        customClass: 'nyan-cat'
      });
      swal.enableLoading();

      fetch(PATH, {
        method: 'POST',
        body: data,
        credentials: 'same-origin',
      })
        .then(res => res.json())
        .then((response) => {
          // Default export is a4 paper, portrait, using millimeters for units
          let doc,
              docAux,
              link,
              ticketFrame,
              imgData,
              tableTop,
              ticketDetails,
              totalCartridges,
              totalPackages, leftMargin,
              initialHeightDoc,
              widthDoc,
              textSize,
              textFormatSize;

          let firstTextMarginTop = 35,
              totalTicket = 0;

          ticketDetails = response['ticket_details'];
          totalCartridges = ticketDetails['cartridges'].length;
          totalPackages = ticketDetails['packages'].length;
          initialHeightDoc = 85;
          leftMargin = 0;
          widthDoc = 58;
          textSize = 24;
          textFormatSize = textSize - 2;

          docAux = new jsPDF();
          docAux.setFontSize(7);

          //  Calcula el alto requerido para el ticket
          for (let i = 0; i < totalCartridges; i++) {
            let text = ticketDetails['cartridges'][i]['name'],
              lines = formatTicketText(text, textFormatSize);
            initialHeightDoc += (2 * lines.length) + 1;
          }
          for (let i = 0; i < totalPackages; i++) {
            let text = ticketDetails['packages'][i]['cartridges'];
            let lines = 'DABBA - ' + text[0] + ', ' + text[1] + ', ' + text[2];
            lines = formatTicketText(lines, textFormatSize);
            initialHeightDoc += (2 * lines.length) + 1;
          }

          doc = new jsPDF({
            unit: 'mm',
            format: [widthDoc, initialHeightDoc]
          });

          // Agrega imagen de encabezado
          imgData = 'data:image/jpeg;base64,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';
          doc.addImage(imgData, 'JPEG', widthDoc / 4 , 4 , widthDoc / 2, widthDoc / 2);

          // Añade fuentes necesarias para el ticket
          // Instrucciones en el siguiente enlace: https://github.com/sphilee/jsPDF-CustomFonts-support/issues/16#issuecomment-307174041
          doc.addFont('dosis-regular.ttf', 'Dosis', 'normal');
          doc.addFont('dosis-bold.ttf', 'Dosis', 'bold');
          doc.addFont('camingocode-regular.ttf', 'Camingo', 'normal');
          doc.addFont('camingocode-bold.ttf', 'Camingo', 'bold');

          doc.setFontSize(10);
          doc.setFont('Dosis', 'bold');
          doc.text('ORDEN ' + ticketDetails['ticket_order'], widthDoc / 2, firstTextMarginTop, null, null, 'center');
          doc.setFont('Dosis', 'normal');
          doc.setFontSize(7);
          firstTextMarginTop += 5;
          doc.text('SUCURSAL SATELITE,', widthDoc / 2, firstTextMarginTop, null, null, 'center');
          firstTextMarginTop += 5;
          doc.text('Calle Hidalgo #78, San Lucas Tepetlaco,', widthDoc / 2, firstTextMarginTop, null, null, 'center');
          firstTextMarginTop += 3;
          doc.text('54055, Tlalnepantla, Méx', widthDoc / 2, firstTextMarginTop , null, null, 'center');
          doc.setFont('Camingo', 'bold');
          doc.setFontSize(7);
          firstTextMarginTop += 5;
          doc.text('NOMBRE \t\tCOST   CANT   TOTAL', leftMargin, firstTextMarginTop, null);
          doc.setFont('Camingo', 'normal');
          doc.setFontSize(6);

          tableTop = firstTextMarginTop + 3;
          // Obtiene la información del ticket para imprimirla
          for (let i = 0; i < totalCartridges; i++) {
            let quantity = ticketDetails['cartridges'][i]['quantity'],
              total = ticketDetails['cartridges'][i]['total'],
              cost = numberFormat(parseFloat(total) / quantity, 2),
              text = ticketDetails['cartridges'][i]['name'],
              lines = formatTicketText(text, textFormatSize);

            doc.text(leftMargin, tableTop, lines, null, null, null);
            doc.text(textSize + 14, tableTop, '$ ' + cost, null, null, 'right');
            doc.text(textSize + 19, tableTop, quantity.toString(), null, null, 'center');
            doc.text(textSize + 34, tableTop, '$ ' + total, null, null, 'right');
            tableTop += (2 * lines.length) + 1;
            totalTicket += parseFloat(total);
          }

          for (let i = 0; i < totalPackages; i++) {
            let quantity = ticketDetails['packages'][i]['quantity'],
              total = ticketDetails['packages'][i]['total'],
              cost = numberFormat(parseFloat(total) / quantity, 2),
              text = ticketDetails['packages'][i]['cartridges'],
              lines = 'DABBA - ' + text[0] + ', ' + text[1] + ', ' + text[2];

            lines = formatTicketText(lines, textFormatSize);
            doc.text(leftMargin, tableTop, lines, null, null, null);
            doc.text(textSize + 14, tableTop, '$ ' + cost, null, null, 'right');
            doc.text(textSize + 19, tableTop, quantity.toString(), null, null, 'center');
            doc.text(textSize + 34, tableTop, '$ ' + total, null, null, 'right');
            tableTop += (2 * lines.length) + 1;
            totalTicket += parseFloat(total);
          }



          // Añade Total del ticket
          doc.setFont('Camingo', 'bold');
          doc.text(textSize + 34, tableTop, '$ ' + numberFormat(totalTicket, 2), null, null, 'right');

          doc.setFont('Dosis', 'bold');
          doc.setFontSize(6);
          doc.text('ID: ' + ticketDetails['ticket_id'], leftMargin, tableTop + 4, null);
          doc.text('Whatsapp: 55 8107 4807', widthDoc / 2, tableTop + 7, null, null, 'center');
          doc.setFont('Dosis', 'bold');
          doc.setFontSize(8);
          doc.text('¡GRACIAS POR SONREIR! :D', widthDoc / 2, tableTop + 12, null, null, 'center');

          imgData = 'data:image/png;base64,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';
          doc.addImage(imgData, 'JPEG', widthDoc / 2.5 , tableTop + 14 , widthDoc / 5, widthDoc / 5);

          doc.autoPrint();
          window.open(doc.output('bloburl'), '_blank');
          
          //link = doc.output('datauristring', null);
          //ticketFrame = document.getElementById('ticket-modal-frame');
          //ticketFrame.setAttribute("src", link);

          //$('#modal-ticket').modal('show');

          swal.close();
        })
        .catch(err => {
          console.error(err);
          swal({
            type: 'error',
            title: 'Oops...',
            text: 'Falló la consulta del ticket',
            footer: 'Avisa a Soporte!',
          })
        });
    });

    /**
     * Función que permite modificar el texto que se requiere para la información del ticket
     * @param text {string} Cadena original
     * @param size {int} Tamaño en que se separará la cadena
     */
    function formatTicketText(text, size) {
        text = text.toUpperCase();
        let aux = [];
        while (text.length > size) {
            aux.push(text.slice(0, size).trim());
            text = text.slice(size);
        }
        if (text.length > 3) {
            aux.push(text.trim());
        }
        return aux;
    }

      /**
     * Refresh the page with de dates of the year and week selected
     */
    $('#dt-week').change(function(event) {
      let dt_year = $('#dt-year').val(),
          dt_week = $('#dt-week').val();

      $.ajax({
        url: "{% url 'sales:sales' %}",
        type: 'POST',
        data: {
          csrfmiddlewaretoken: '{{ csrf_token }}',
          'dt_year': dt_year,
          'dt_week': dt_week,
          'type': 'sales_week',
        },
        beforeSend: function(){
          swal({
            title: "Obteniendo registros",
            text: "Espere mientras obtenemos toda la información",
          });
          swal.enableLoading();
        },
        traditional: true,
        datatype: 'jsonp',
        success: function(result, status, XHR) {
          let tickets_objects = result['tickets'],
              sales_week = result['sales'],
              week_number = result['week_number'],
              sales_details_table = $('#sales-details-table').find('tbody'),
              week_earnings = 0;

          sales_details_table.empty();

          swal({
            title: "Éxito",
            text: "Datos obtenidos",
            type: "info",
            timer: 750,
            showConfirmButton: false
          }).then(
          function(){},
          function(dismiss){});

          /**
           * Filling the sales table
           */
          for (let i = 0; i < tickets_objects.length; i++) {
            week_earnings += parseFloat(tickets_objects[i].total);
            let cartridges_list = "";
            let packages_list = "";

            for (let j = 0; j < tickets_objects[i]['cartridges'].length; j++) {
              cartridges_list += "" +
              "<span class='badge badge-success'>" +
                "<span class='badge badge-info'>" +
                tickets_objects[i]['cartridges'][j].quantity +
                "</span>" +
                "<span class='badge badge-success'>" +
                tickets_objects[i]['cartridges'][j].name +
                "</span>" +
              "</span>" +
              "";
            }

            for (let j = 0; j < tickets_objects[i]['packages'].length; j++) {
              packages_list += "" +
              "<span class='badge badge-primary'>" +
                "<span class='badge badge-info'>" +
                tickets_objects[i]['packages'][j].quantity +
                "</span>" +
                "<span class='badge badge-primary'>" +
                tickets_objects[i]['packages'][j].name +
                "</span>" +
              "</span>" +
              "";
            }

            sales_details_table.append("" +
              "<tr class='table-row>" +
              "<th class='header-id table-row-id'>" + tickets_objects[i].id + "</th>" +
              "<th>" + tickets_objects[i].order_number + "</th>" +
              "<td class='header-date'>" + tickets_objects[i].created_at + "</td>" +
              "<td class='header-products'>" + cartridges_list + "</td>" +
              "<td class='header-packages'>" + packages_list + "</td>" +
              "<td>" + tickets_objects[i].cashier + "</td>" +
              "<td class='td-total'>" + tickets_objects[i].total + "</td>" +
              "<td class='header-actions'>" +
              "<span class='sales-actions delete-ticket'><i class='material-icons text-muted'>delete</i></span>" +
              "<span class='sales-actions print-ticket'><i class='material-icons text-primary'>local_printshop</i></span>" +
              "</td>" +
              "</tr>" +
            "");
          }

          earnings_week_chart.data.datasets[0].data = get_earnings_week_range(sales_week);
          earnings_week_chart.update();

          $('#total-earnings-text').text(week_earnings.toFixed(2));
          $('#week-number').text(week_number);

        },
        error: function(result, jqXHR, textStatus, errorThrown) {
          console.log(result);
        },
        complete: function(result){}
      });
    });

    /**
     * Buscar un elemento padre en el DOM
     */
    function findParentBySelector(elm, selector) {
      let all = document.querySelectorAll(selector);
      let cur = elm.parentNode;

      function collectionHas(a, b) { //helper function (see below)
        for (let i = 0, len = a.length; i < len; i++) {
          if (a[i] == b) return true;
        }
        return false;
    }

    while (cur && !collectionHas(all, cur)) { //keep going up until you find a match
      cur = cur.parentNode; //go up
    }
    return cur; //will return null if not found
    }

    /**
     * Obtención de Cookies
     *
     */
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        let cookies = document
            .cookie
            .split(';');
        for (let i = 0; i < cookies.length; i++) {
          let cookie = cookies[i].trim();
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    /**
     * Permite dar formato con decimales a un numero
     * @param amount
     * @param decimals
     * @returns {string}
     */
    function numberFormat(amount, decimals) {
      amount += ''; // por si pasan un numero en vez de un string
      amount = parseFloat(amount.replace(/[^0-9\.]/g, '')); // elimino cualquier cosa que no sea numero o punto

      decimals = decimals || 0; // por si la variable no fue fue pasada

      // si no es un numero o es igual a cero retorno el mismo cero
      if (isNaN(amount) || amount === 0)
        return parseFloat(0).toFixed(decimals);

      // si es mayor o menor que cero retorno el valor formateado como numero
      amount = '' + amount.toFixed(decimals);

      let amount_parts = amount.split('.'),
          regexp = /(\d+)(\d{3})/;

      while (regexp.test(amount_parts[0]))
        amount_parts[0] = amount_parts[0].replace(regexp, '$1' + ',' + '$2');

      return amount_parts.join('.');
    }

    function formatWordsTicket(text) {
      switch (text) {
        case "JUGO":
            return "JUG";
        case "ROTI":
          return "R";
        case "AGUA":
          return "AG";
        case "ENSALADA":
          return "E";
        case "LICUADO":
          return "LIC";
        case "ALFALFA":
          return "A";
      }
      return text;
    }
    /**
     * Functions to initialize the graphs
     */
    fill_dates_range_form();
    set_total_earnings();
    set_sales_day_chart(today_date);
  });
</script>
{% endblock javascript %}
